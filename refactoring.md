# 关于重构的重构 - 《重构》第二版导读

近20年过去了，Martin Fowler先生终于推出了新版的《重构》。本人有幸于ThoughtWorks技术雷达十周年峰会现场率先拿到了此书的国内发行版。

在这20年中，软件开发技术发生了很多重要的变化。新的编程语言不断涌现，老的编程语言也加快迭代。主流编程语言大都支持了多种编程范式，函数式编程和面向对象一样成了主流编程语言的标配。对并发的更好支持也已成为主流编程语言新的核心竞争力。于此同时各种软件开发工具也日益现代化，主流编程IDE都具备了面向重构、测试甚至容器化发布的自动化工具和快捷键。

基于上，很多人都以为新版的重构会迎合时代的变化，焕然一新。然而当我用一整天时间读完全书后，却不禁如释重负。正如本书中文译者熊节先生所说“Flowler先生不仅没有拔高，反而把功夫做的更扎实了”。

确实，无论编程语言的语法如何变化、编程范型如何多元化、工具如何发展，软件设计的目标并没有变：那就是如何在保证软件满足功能和非功能需求的前提下，更易应对变化，更易让人理解和维护。由此所推导出来的软件设计原则更是几十年都没有变，如`高内聚、低耦合`，如`SOLID原则`等。甚至连`GOF设计模式`至今仍然生命力旺盛，除了偶有在一些新的编程泛型中出现的新模式以及对原有模式的更简单实现等。此刻再回顾重构技术，它所传授的如何识别代码中的坏味道，以及如何采用小步安全的重构手法逐步将代码演化到更易理解、更易应对变化的状态，正是为了满足软件设计的核心诉求。所以重构应该是和设计模式一样，是一种软件开发中历久而弥新的核心能力。

因此在大的结构方面，新版的重构和第一版相似。首先从一个类似的示例开始，先让读者从整体上体会重构的过程和效果。然后Martin给出了重构的具体概念和原则。之后他给读者列出了一份重要的代码坏味道列表并逐一诠释。随后作者讲了对于重构来说至关重要的“测试体系构筑”。最后Martin按照一定的分类和顺序逐一讲解了几十种常用的重构手法。

在所谓与时俱进方面，Martin则将更多的精力放在了对细节的持续优化上。首先直接可见的是新版删除了第一版中的最后几章：“大型重构”、“重构，复用与现实”，“重构工具”等，一方面是因为这几章中有些内容在今天看来已不是那么重要，其次是因为所谓的“大型重构”其实仍旧是一系列小的重构手法的合理组合和持续应用。因此在第二版中Martin将重点放到了对重构手法的持续优化上。首先他将原本22种代码坏味道调整为24种，然后逐一详细讲解每种重构手法。新版中保留了第一版中大部分的重构手法，只是对细节进行了优化，同时删除了几个不再重要的手法，增加了一些当下比较有用的手法。Martin对所有这些手法重新进行了分类和顺序排布，以便更加内聚和操作连贯。除这些之外，整本书的示例语言也从Java换成了JavaScript。

本文接下来一一介绍这些变化。

## JavaScript

不少人认为第二版中将重构的示例语言由Java变为JavaScript，并不是一种妥当的选择。毕竟JavaScript作为一门动态脚本语言，并不适合较大规模的工业级软件产品。但我个人认为选择JavaScript是经过Martin深思熟虑的。

自从NodeJs将JavaScript带进了服务端开发，JavaScript就变成了一门前后端通吃的语言。此外，ES6标准将JavaScript变成了一门现代语言，语法上同时支持面向对象和函数式范式。最后JavaScript内置多种支持并发编程的特性，它的包管理工具和生态也都建设得非常好。相比其它语言，JavaScript的受众以及可应用的领域更加的广泛。

由于动态语言的灵活性，所以一般IDE对动态语言的自动化重构支持的并没有静态语言那么好。正因如此，对于动态语言，安全的手动重构步骤才会显得更有意义。熟练掌握手动重构技巧，不仅能更好的理解重构的本质，对在其它主流编程语言下实施重构也非常有价值（例如C、C++、Python等）。

其次借助动态语言的灵活性，很多重构手法其实可以做的更加灵活和简单。例如JavaScript支持在函数内嵌套定义函数，所以应用`Extract Method`手法时，可以先把新提来出来的子函数定义在调用它的函数内部，这样借助函数的闭包性可以减少函数间传递的参数数量。等到真正需要复用该子函数的时候再把它挪到外面。全书中类似的例子还有很多。

在书中，Martin使用了ES6的语法，不仅因为ES6标准为JavaScript引入了类和继承的语法糖，而且在很多细节上也能让代码更加清晰。例如书中对`const`和`let`关键字的大量使用等。同时Martin也尽量避免使用其他程序员不太熟悉的JavaScript编程风格，例如JS独特的对象模型以及`generator`、`promise`和`await/async`等语法。

## 代码坏味道


## 重构手法


## 重构示例


## 写在最后

